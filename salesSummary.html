<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Sales Summary</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styleitems.css">
    <style>
        .summary-wrapper { padding: 20px; max-width: 1100px; margin: 0 auto; max-height: calc(100vh - 120px); overflow-y: auto; }
        .txn { background:#3D3D3D; padding:12px; border-radius:8px; margin-bottom:12px; }
        .txn h4 { margin:0 0 8px 0; color:#D1BFA7; }
        .txn pre { white-space: pre-wrap; color:#EFEFEF; }
        .controls { display:flex; gap:12px; margin-bottom:16px; }
        .end-sales-btn { position: fixed; right: 18px; bottom: 18px; z-index: 9999; padding: 12px 16px; border-radius: 8px; background:#D1BFA7; color:#222; border: none; cursor:pointer; box-shadow: 0 2px 6px rgba(0,0,0,.25); }
    </style>
</head>
<body>
    <div class="top-bar">
        <button id="menuToggle" type="button" aria-expanded="false" aria-controls="drawer" aria-label="Open menu">‚ò∞</button>
        <div class="title">Moon Light Ice Cream Parlor</div>
        <div id="grandTotal" style="font-weight:700; margin-bottom:12px">Grand Total: ‚Çπ0</div>
        <button class="button-18" id="endSalesBtn">End Sales</button>
    </div>

    <div class="drawer" id="drawer">
        <a href="index.html">Home</a>
        <a href="salesSummary.html">Sales Summary</a>
        <a href="about.html">About Us</a>
    </div>
    <div class="summary-wrapper">
        <div style="display: block;;text-align:center"><h2>Sales Summary</h2></div>
        <br>
        <div class="controls">
            <button id="backBtn" class="button-18">‚¨ÖÔ∏è Back</button>
            <button id="clearBtn" class="button-18">üóëÔ∏è Clear All</button>
        </div>
        <br>
        <div id="list"></div>
    </div>

    <script>
        (function () {
            const drawer = document.getElementById('drawer');
            const menuToggle = document.getElementById('menuToggle');
            if (!drawer || !menuToggle) return;
            menuToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = drawer.classList.toggle('open');
                menuToggle.setAttribute('aria-expanded', String(isOpen));
            });
            document.addEventListener('click', () => {
                if (drawer.classList.contains('open')) {
                    drawer.classList.remove('open');
                    menuToggle.setAttribute('aria-expanded', 'false');
                }
            });
            drawer.addEventListener('click', (e) => e.stopPropagation());
        })();

        function render() {
            const key = 'sales_summary';
            const listEl = document.getElementById('list');
            listEl.innerHTML = '';
            const raw = localStorage.getItem(key);
            if (!raw) {
                listEl.innerHTML = '<p>No transactions yet.</p>';
                window.currentGrandTotal = 0;
                const g = document.getElementById('grandTotal'); if (g) g.textContent = 'Grand Total: ‚Çπ0';
                return;
            }
            let arr = [];
            try { arr = JSON.parse(raw); } catch (e) { listEl.innerHTML = '<p>Failed to read sales summary.</p>'; return; }
            if (!arr.length) { listEl.innerHTML = '<p>No transactions yet.</p>'; const g = document.getElementById('grandTotal'); if (g) g.textContent = 'Grand Total: ‚Çπ0'; window.currentGrandTotal = 0; return; }
            // compute grand total across all transactions
            const grandTotalEl = document.getElementById('grandTotal');
            const totalSum = arr.reduce((sum, t) => {
                const v = parseFloat(t.total);
                return sum + (Number.isFinite(v) ? v : 0);
            }, 0);
            if (grandTotalEl) grandTotalEl.textContent = `Grand Total: ‚Çπ${totalSum}`;
            window.currentGrandTotal = totalSum;
            // show newest first
            arr.slice().reverse().forEach(txn => {
                const node = document.createElement('div');
                node.className = 'txn';
                const when = new Date(txn.timestamp).toLocaleString();
                const h = document.createElement('h4');
                h.textContent = `Table: ${txn.table} ‚Äî ${when} ‚Äî Total: ‚Çπ${txn.total}`;
                node.appendChild(h);
                const pre = document.createElement('pre');
                pre.textContent = txn.items.map(i => `${i.name} x ${i.qty} = ‚Çπ${i.total}`).join('\n');
                node.appendChild(pre);
                // add delete button for this transaction
                const del = document.createElement('button');
                del.className = 'button-18';
                del.style.marginTop = '8px';
                del.textContent = 'Delete Transaction';
                del.addEventListener('click', () => {
                    if (!confirm('Delete this transaction? This cannot be undone.')) return;
                    try {
                        const stored = JSON.parse(localStorage.getItem(key) || '[]');
                        const filtered = stored.filter(s => String(s.timestamp) !== String(txn.timestamp));
                        localStorage.setItem(key, JSON.stringify(filtered));
                    } catch (e) {
                        // ignore parse error
                    }
                    render();
                });
                node.appendChild(del);
                listEl.appendChild(node);
            });
        }

        document.getElementById('backBtn').addEventListener('click', () => { window.history.back(); });
        document.getElementById('clearBtn').addEventListener('click', () => {
            if (!confirm('Clear all saved sales?')) return;
            localStorage.removeItem('sales_summary');
            render();
        });

        // End Sales button: record current grand total into a persistent list
        const endBtn = document.getElementById('endSalesBtn');
        if (endBtn) {
            endBtn.addEventListener('click', () => {
                if (!confirm('Record current grand total to About Us?')) return;
                const key = 'sales_endings';
                let existing = [];
                try { existing = JSON.parse(localStorage.getItem(key) || '[]'); } catch (e) { existing = []; }
                const total = (typeof window.currentGrandTotal === 'number') ? window.currentGrandTotal : parseFloat(String(document.getElementById('grandTotal')?.textContent || '0').replace(/[^0-9.\-]/g, '')) || 0;
                existing.push({ timestamp: Date.now(), total: Number(total) });
                localStorage.setItem(key, JSON.stringify(existing));
                alert('Saved end-of-sales record. Opening About Us...');
                window.location.href = 'about.html';
            });
        }

        render();
    </script>
</body>
</html>